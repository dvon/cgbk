<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        
        
        <link rel="stylesheet" href="/cgbk/css/trac.css" />
        
        
        <link rel="stylesheet" href="/cgbk/css/style.css" />
        
        
        
        
        <style>
            h1::before {
                content: "Lesson 2: "
            }
            body {
                counter-reset: lc 2 ec 0;
            }
            .exercise_label::after {
                counter-increment: ec;
                content: counter(lc) "." counter(ec) ":";
            }
        </style>
        
        
    </head>
    <body>
        <div class="content">
            <h1>JavaScript (Part 2)</h1>

<p>Continuing on from the previous lesson, this lesson shows how
to create objects with members (i.e., fields and methods)
that behave the way public and private instance members, and
public and private static members, would in a language like Java.</p>

<h2>Using Functions to Create Objects with Private Members</h2>

<p>In a typical object-oriented programming language, the distinction
made between a class and an object goes something like this:  a
class is a blueprint; an object is a thing created based on that
blueprint.  So you can expect the object to have whatever members
are specified in the blueprint&hellip;etc.  But there&rsquo;s another way to
think about the distinction:  a class is a bit of code you can
look at in a text editor; an object is a thing that&rsquo;s created when
your program runs, based on that code.  When you create an object,
memory is allocated for the new object.  When you create another
object, although it might be based on the same class, you have to
allocate more memory for it.  Each object has its own memory, to
store its own unique state.</p>

<p>So what does it means to say that, in JavaScript, a function is an
object?  Not just that the function can have member fields and
methods, but that the function is <em>created</em>, not defined.  The
function is not (just) a
bit of code you can look at in a text editor, it&rsquo;s a thing that gets
created when your program runs.  And when the function object is
created, memory is allocated to store its unique state.  The fact
that functions have state, in JavaScript, means that they can
remember things from one invocation to the next.</p>

<p>To illustrate this, here&rsquo;s yet another version of the second
example from the section on immediate functions.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span><span class="p">;</span>

    <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;David&quot;</span><span class="p">;</span>

    <span class="nx">hello</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Dave&quot;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}());</span>

<span class="nx">hello</span><span class="p">();</span>  <span class="c1">// prints &quot;David&quot;</span>
<span class="nx">hello</span><span class="p">();</span>  <span class="c1">// prints &quot;Dave&quot;</span>
</code></pre></div>
<p>A function created this way, so that it includes as part of its
state a variable declared outside it, is called a <em>closure</em>.  Notice
that, even though <code>hello</code> is being called outside the immediate
function that contains its definition (i.e., the statement that
creates it), it still has access to the <code>name</code> variable.  <code>hello</code>
behaves like a public method with access to a private field, a
standard pattern in a typical object-oriented language like Java.</p>

<p>Here&rsquo;s the <code>PigPlayer</code> constructor again, this time using
closures to make <code>holdAmount</code> and <code>score</code> private fields.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">holdAmount</span><span class="p">,</span> <span class="nx">score</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">PigPlayer</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmountArg</span><span class="p">;</span>
    <span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rollScore</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">turnScore</span> <span class="o">&lt;</span> <span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">rollScore</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">rollScore</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">turnScore</span> <span class="o">+=</span> <span class="nx">rollScore</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">score</span> <span class="o">+=</span> <span class="nx">turnScore</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To clarify what&rsquo;s going on here&hellip;  The <code>getScore</code> function
includes a reference to <code>PigPlayer</code>&rsquo;s <code>score</code> field; the <code>takeTurn</code>
function includes references to both <code>score</code> and <code>holdAmount</code>.
Because <code>score</code> and <code>holdAmount</code> are declared within <code>PigPlayer</code>,
you might expect they&rsquo;d be deallocated when <code>PigPlayer</code> returns
and they go out of scope.  But they are kept around for the sake
of <code>score</code> and <code>takeTurn</code>, because they&rsquo;ll be needed if these
functions are called later.</p>

<p><code>holdAmount</code> and <code>score</code> act like private fields would
in a language like Java&mdash;they aren&rsquo;t directly accessible from
outside the object, but they persist as part of the object&rsquo;s
state, accessible to the object&rsquo;s methods (and therefore
indirectly accessible outside the object).  We&rsquo;ll take this
idea further in the next section, considering how we can create
variables and functions that act like private or public members
of an object, and also static vs. instance members.</p>

<p><em><strong><span class="exercise_label">Exercise </span></strong></em>  <em>Write a function (or more than one) to read multiple files
concurrently.  It should create <code>XMLHttpRequest</code> objects and
call <code>send</code> for all the files, not waiting for one to finish
loading before sending the request for another.  In addition,
it should be able to determine when all of the files are loaded,
and should at that point call a callback function passed in as
an argument.</em><sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup></p>

<p><em>Here&rsquo;s how it might look to call your function.</em></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">printResponses</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">responses</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">responses</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">responses</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">fileNames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hello.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;salut.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;hola.txt&quot;</span><span class="p">];</span>
<span class="nx">readFiles</span><span class="p">(</span><span class="nx">fileNames</span><span class="p">,</span> <span class="nx">printResponses</span><span class="p">);</span>
</code></pre></div>
<p><em>Hint:  You can use an immediate function any time you need to
limit the scope of a variable.  My solution for this exercise
uses an immediate function within a loop, an idea illustrated
by the example below.</em></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>  <span class="c1">// prints &quot;2&quot; (5 times)</span>
    <span class="p">}());</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>  <span class="c1">// prints &quot;1&quot;</span>
</code></pre></div>
<h2>Public, Private, Static</h2>

<p>If you add a variable to <code>this</code> in a constructor, it acts
like a public instance field.  Similarly, if you add a function
to <code>this</code> in a constructor, it acts like a public instance method.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">PigPlayer</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// public instance field</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmountArg</span><span class="p">;</span>

    <span class="c1">// public instance method</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">increaseHold</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">amount</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">holdAmount</span> <span class="o">+=</span> <span class="nx">amount</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">holdAmount</span><span class="p">);</span>  <span class="c1">// prints &quot;25&quot;</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">increaseHold</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">holdAmount</span><span class="p">);</span>  <span class="c1">// prints &quot;35&quot;</span>
</code></pre></div>
<p>If you add a variable or function within the constructor but don&rsquo;t
assign it to <code>this</code>, it will act like a private field or method.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">holdAmount</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">rollDice</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">PigPlayer</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// private instance fields</span>
    <span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmountArg</span><span class="p">;</span>
    <span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// public instance method</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

    <span class="c1">// private instance method</span>
    <span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// public instance method</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rollScore</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">turnScore</span> <span class="o">&lt;</span> <span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">rollScore</span> <span class="o">=</span> <span class="nx">rollDice</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">rollScore</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">turnScore</span> <span class="o">+=</span> <span class="nx">rollScore</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">score</span> <span class="o">+=</span> <span class="nx">turnScore</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>

<span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">holdAmount</span><span class="p">);</span>  <span class="c1">// prints &quot;undefined&quot;</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">takeTurn</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">getScore</span><span class="p">());</span>  <span class="c1">// prints updated score...</span>
</code></pre></div>
<p>Notice a couple things about the code above&hellip;  The third to last
line prints <code>undefined</code> because <code>holdAmount</code> isn&rsquo;t accessible
directly as a member of <code>p</code>.  But <code>holdAmount</code> is still part of
<code>p</code>&rsquo;s state; it&rsquo;s accessed indirectly when <code>takeTurn</code> is called.
So <code>holdAmount</code> acts like a private instance field.</p>

<p>Also notice the <code>rollDice</code> method, marked by the comment above it
as a private instance method.  Actually it could have been marked
as a private <em>static</em> method instead, since it doesn&rsquo;t access any
instance fields or methods, i.e., it doesn&rsquo;t use <code>this</code>.  What if
it did?  You would probably expect that, if <code>p.takeTurn()</code> were
used to call <code>takeTurn</code> and, within <code>takeTurn</code>, <code>rollDice</code> were
called&mdash;you&rsquo;d expect that if <code>rollDice</code> used <code>this</code> that it would
refer to <code>p</code>.  But it wouldn&rsquo;t.  In JavaScript, if you call a
function from an object variable (<code>x.doSomething()</code>), <code>this</code> is
assigned the object (<code>x</code>) within the function; but if you don&rsquo;t
(<code>doSomething()</code>), <code>this</code> still points to a global object.  And
this is true even for <code>rollDice</code> in the example above.</p>

<p>How can we get around this problem?  We&rsquo;ll look at two ways here.
First, <code>this</code> could be assigned to a local variable.  Second, we
could forget <code>this</code> altogether&mdash;just create a new object, assigned
to a local variable, and return that object at the end of the
constructor (instead of returning <code>this</code>, which is what happens
when you don&rsquo;t include a <code>return</code> statement).</p>

<p>Here&rsquo;s the first way.  (Unfortunately the convention is to use
<code>that</code> when you assign <code>this</code> to a local variable; it&rsquo;s confusing,
but I&rsquo;m sticking to the convention here.)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">holdAmount</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">rollDice</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">PigPlayer</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Assign &quot;this&quot; to a local variable, for the sake of any</span>
    <span class="c1">// private (i.e., declared with &quot;var&quot; in this function)</span>
    <span class="c1">// methods that need to access public instance members.</span>
    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmountArg</span><span class="p">;</span>
    <span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

    <span class="c1">// If rollDice used &quot;this&quot; it would refer to a global object,</span>
    <span class="c1">// which would be (very) bad.  But if it used &quot;that&quot; it would</span>
    <span class="c1">// refer to the object rollDice was added to when it was</span>
    <span class="c1">// created, which would be good.</span>
    <span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>
<span class="p">};</span>
</code></pre></div>
<p>And here&rsquo;s the second way.  I&rsquo;ve called the new object variable
<code>pb</code>, for &ldquo;public&rdquo; (less to type, but also because <code>public</code> is a
keyword in JavaScript), since anything I add to <code>pb</code> will become
a public member of the object.  Notice that the <code>if</code> statement at
the beginning, to make sure <code>new</code> was used when the constructor
was called, is no longer necessary.  The point of making sure
<code>new</code> was used was to make sure <code>this</code> wouldn&rsquo;t refer to a global
object.  But this version of <code>PigPlayer</code> doesn&rsquo;t use <code>this</code> at all,
so it doesn&rsquo;t matter whether <code>new</code> is used to call it.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmountArg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pb</span><span class="p">,</span> <span class="nx">holdAmount</span><span class="p">,</span> <span class="nx">score</span><span class="p">,</span> <span class="nx">rollDice</span><span class="p">;</span>

    <span class="c1">// Create a new empty object; assign it to pb, which will be</span>
    <span class="c1">// a container for public members.</span>
    <span class="nx">pb</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmountArg</span><span class="p">;</span>
    <span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">pb</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

    <span class="c1">// Would be fine for a private instance method like rollDice</span>
    <span class="c1">// to refer to &quot;pb&quot;.  (Compare to previous version...would not</span>
    <span class="c1">// have been fine for rollDice to refer to &quot;this&quot; in that</span>
    <span class="c1">// version.)</span>
    <span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>

    <span class="nx">pb</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>

    <span class="c1">// Instead of returning &quot;this&quot; (which would happen</span>
    <span class="c1">// automatically if PigPlayer were called with new and had</span>
    <span class="c1">// no return statement), return pb, the container object for</span>
    <span class="c1">// public members.</span>
    <span class="k">return</span> <span class="nx">pb</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>To make the code a little clearer, we can use <code>pv</code> as a container
for private members in the same way <code>pb</code> is used for public
members.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pb</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">pv</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">pv</span><span class="p">.</span><span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmount</span><span class="p">;</span>
    <span class="nx">pv</span><span class="p">.</span><span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">pb</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

    <span class="nx">pv</span><span class="p">.</span><span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>

    <span class="nx">pb</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{...};</span>

    <span class="k">return</span> <span class="nx">pb</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>What about static members?  In the following example, <code>numDice</code>
would act like a private static field.  It&rsquo;s created just once,
when the immediate function wrapping <code>PigPlayer</code> runs&hellip;  TODO</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numDice</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{...};</span>
<span class="p">}());</span>
</code></pre></div>
<p>We have a container object for public instance members (<code>pb</code>),
and one for private instance members (<code>pv</code>).  Why not create one
for private static members like <code>numDice</code>?  And why not make
<code>rollDice</code> a (private) static method, since it doesn&rsquo;t need to
access any instance members?</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ps</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// private static field</span>
    <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="c1">// private static method</span>
    <span class="nx">ps</span><span class="p">.</span><span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">total</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{...};</span>
<span class="p">}());</span>
</code></pre></div>
<p>One more possibility would be to include public static members.
In Java, these would be accessed via the class name (i.e.,
<code>Math.random</code>).  It&rsquo;s possible to do the same thing in JavaScript,
as illustrated by the example below.<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup>  (To avoid repetition I left
out parts of the code in the last few examples, but I&rsquo;ve included
the whole thing here since this is the last version of the code.)</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ps</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="c1">// private static field</span>
    <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="c1">// private static method</span>
    <span class="nx">ps</span><span class="p">.</span><span class="nx">rollDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">total</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">total</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">PigPlayer</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pb</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">pv</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="c1">// private instance fields</span>
        <span class="nx">pv</span><span class="p">.</span><span class="nx">holdAmount</span> <span class="o">=</span> <span class="nx">holdAmount</span><span class="p">;</span>
        <span class="nx">pv</span><span class="p">.</span><span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="c1">// public instance methods</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nx">getScore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">score</span><span class="p">;</span> <span class="p">};</span>

        <span class="nx">pb</span><span class="p">.</span><span class="nx">takeTurn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rollScore</span><span class="p">;</span>

            <span class="k">while</span> <span class="p">(</span><span class="nx">turnScore</span> <span class="o">&lt;</span> <span class="nx">pv</span><span class="p">.</span><span class="nx">holdAmount</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">rollScore</span> <span class="o">=</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">rollDice</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">rollScore</span> <span class="o">&gt;</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">turnScore</span> <span class="o">+=</span> <span class="nx">rollScore</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">turnScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">pv</span><span class="p">.</span><span class="nx">score</span> <span class="o">+=</span> <span class="nx">turnScore</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">pb</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// public static method</span>
    <span class="nx">PigPlayer</span><span class="p">.</span><span class="nx">setNumDice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">numDice</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ps</span><span class="p">.</span><span class="nx">numDice</span> <span class="o">=</span> <span class="nx">numDice</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}());</span>
</code></pre></div>
<p>It would be possible to add a public static field in the same way;
just add it as a member to <code>PigPlayer</code> after the <code>PigPlayer</code>
function.  There&rsquo;s just one possible problem to be aware of.
Suppose we defined <code>maxHold</code>, after <code>setNumDice</code>, in the following
way.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PigPlayer</span><span class="p">.</span><span class="nx">maxHold</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</code></pre></div>
<p>As long as we always accessed <code>maxHold</code> via <code>PigPlayer</code>, everything
would be fine.  But what about this?</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PigPlayer</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">...</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">maxHold</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
</code></pre></div>
<p>Rather than changing <code>PigPlayer.maxHold</code>, this statement would add
<code>maxHold</code> to <code>p</code> as a public instance field and initialize it to
40.  You wouldn&rsquo;t get any error message, the code just wouldn&rsquo;t
do what you intend.  Because of this you might want to avoid
public instance fields.  Instead, you could just use a variable
declared in such a way that its scope contains all
instances.</p>

<p><em><strong><span class="exercise_label">Exercise </span></strong></em>  <em>Why is it that <code>setNumDice</code> isn&rsquo;t defined at the beginning
with private static members?  Or what if <code>setNumDice</code> were
defined inside <code>PigPlayer</code>?  What difference would that make?</em></p>

<p><em><strong><span class="exercise_label">Exercise </span></strong></em>  <em>Translate the following Java class into a JavaScript function,
following the pattern of the final version of <code>PigPlayer</code>
above:  use <code>ps</code> for any private static members, <code>pb</code> for
any public instance members, and <code>pv</code> for any private instance
members; add any public static members to the constructor object
(e.g., <code>PigPlayer</code>) after adding the constructor function.
(You may assume <code>SpriteDrawer</code> is defined somewhere else, i.e,
add it to your JSLint <code>/*global</code> line at the beginning of the
file.)</em></p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sprite</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">minX</span><span class="o">,</span> <span class="n">minY</span><span class="o">,</span> <span class="n">maxX</span><span class="o">,</span> <span class="n">maxY</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">minX</span> <span class="o">=</span> <span class="n">minY</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">maxX</span> <span class="o">=</span> <span class="mi">640</span><span class="o">;</span>
        <span class="n">maxY</span> <span class="o">=</span> <span class="mi">480</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">filename</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">xPos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">yPos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">movable</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Sprite</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">,</span> <span class="kt">double</span> <span class="n">xPos</span><span class="o">,</span> <span class="kt">double</span> <span class="n">yPos</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">movable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">;</span>
        <span class="n">forceMove</span><span class="o">(</span><span class="n">xPos</span><span class="o">,</span> <span class="n">yPos</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">movable</span> <span class="o">=</span> <span class="n">movable</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">forceMove</span><span class="o">(</span><span class="kt">double</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">double</span> <span class="n">dy</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">xPos</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">;</span>
        <span class="n">yPos</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">xPos</span> <span class="o">&lt;</span> <span class="n">minX</span><span class="o">)</span> <span class="n">xPos</span> <span class="o">=</span> <span class="n">minX</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xPos</span> <span class="o">&gt;</span> <span class="n">maxX</span><span class="o">)</span> <span class="n">xPos</span> <span class="o">=</span> <span class="n">maxX</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">yPos</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="o">)</span> <span class="n">yPos</span> <span class="o">=</span> <span class="n">minY</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">yPos</span> <span class="o">&gt;</span> <span class="n">maxY</span><span class="o">)</span> <span class="n">yPos</span> <span class="o">=</span> <span class="n">maxY</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">(</span><span class="kt">double</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">double</span> <span class="n">dy</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">movable</span><span class="o">)</span> <span class="n">forceMove</span><span class="o">(</span><span class="n">dx</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hide</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">visible</span><span class="o">)</span>
            <span class="n">SpriteDrawer</span><span class="o">.</span><span class="na">draw</span><span class="o">(</span><span class="n">filename</span><span class="o">,</span> <span class="n">xPos</span><span class="o">,</span> <span class="n">yPos</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkCollision</span><span class="o">(</span><span class="n">Sprite</span> <span class="n">that</span><span class="o">,</span>
            <span class="kt">double</span> <span class="n">collisionDistance</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">dx</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">xPos</span> <span class="o">-</span> <span class="n">that</span><span class="o">.</span><span class="na">xPos</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">dy</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">yPos</span> <span class="o">-</span> <span class="n">that</span><span class="o">.</span><span class="na">yPos</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">collisionDistance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p>In case you are worried about the possibility of a race condition, if for example you had multiple callback functions trying to modify a shared variable at the same time&hellip;you don&rsquo;t need to worry about that.  In JavaScript a function runs as an <em>atomic</em> piece of code, i.e., its execution won&rsquo;t be interleaved with that of another function. For more details: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop">https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop</a>&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>A different way to simulate public static members would be to use the <code>prototype</code> member automatically created for function objects and assigned to <code>this</code> when the function is invoked as a constructor (i.e., with <code>new</code>).  I&rsquo;ve chosen not to do it this way, and to avoid a general discussion of how <code>prototype</code> works in Javascript, in order to keep this lesson from getting too long.&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

        </div>
    </body>
</html>
